apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: example-system

resources:
  - serviceaccount.yaml
  - deployment.yaml
  - service.yaml
  - secret.yaml
  - rbac-auth-reader.yaml
  - rbac-cluster.yaml

labels:
  - includeSelectors: true
    includeTemplates: true
    pairs:
      app.kubernetes.io/name: example-service
      app.kubernetes.io/instance: example-service-apiserver
      app.kubernetes.io/component: apiserver
      app.kubernetes.io/part-of: example.example-org.io
      app.kubernetes.io/managed-by: kustomize

# Images (will be replaced by overlays for different environments)
images:
  - name: ghcr.io/example-org/example-service
    newTag: latest

# JSON patches to ensure rbac-auth-reader stays in kube-system
# These are applied AFTER all other transformations
patches:
  - target:
      kind: RoleBinding
      name: example-service-apiserver-auth-reader
    patch: |-
      - op: replace
        path: /metadata/namespace
        value: kube-system
      - op: replace
        path: /subjects/0/namespace
        value: example-system
