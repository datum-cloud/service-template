apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-service-apiserver
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example-service-apiserver
  template:
    metadata:
      labels:
        app: example-service-apiserver
    spec:
      serviceAccountName: example-service-apiserver
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: apiserver
        image: ghcr.io/example-org/example-service:latest
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65532
          capabilities:
            drop:
            - ALL
        ports:
        - containerPort: 8443
          name: https
          protocol: TCP
        command:
        - /example-service
        - serve
        args:
        - --secure-port=$(SECURE_PORT)
        - --tls-cert-file=$(TLS_CERT_FILE)
        - --tls-private-key-file=$(TLS_PRIVATE_KEY_FILE)
        # TEMPLATE NOTE: Add your service-specific flags here
        # Example: database connections, external APIs, feature flags, etc.
        - --kubeconfig=$(KUBECONFIG)
        - --authentication-kubeconfig=$(AUTHENTICATION_KUBECONFIG)
        - --authentication-skip-lookup=$(AUTHENTICATION_SKIP_LOOKUP)
        - --authentication-tolerate-lookup-failure=$(AUTHENTICATION_TOLERATE_LOOKUP_FAILURE)
        - --authorization-kubeconfig=$(AUTHORIZATION_KUBECONFIG)
        - --authorization-always-allow-paths=$(AUTHORIZATION_ALWAYS_ALLOW_PATHS)
        - --requestheader-client-ca-file=$(REQUESTHEADER_CLIENT_CA_FILE)
        - --requestheader-username-headers=$(REQUESTHEADER_USERNAME_HEADERS)
        - --requestheader-group-headers=$(REQUESTHEADER_GROUP_HEADERS)
        - --requestheader-uid-headers=$(REQUESTHEADER_UID_HEADERS)
        - --requestheader-extra-headers-prefix=$(REQUESTHEADER_EXTRA_HEADERS_PREFIX)
        - --logging-format=$(LOGGING_FORMAT)
        - --tracing-config-file=$(TRACING_CONFIG_FILE)
        - -v=$(LOG_LEVEL)
        env:
        - name: SECURE_PORT
          value: "8443"
        - name: TLS_CERT_FILE
          value: "/var/run/example-service-apiserver/tls/tls.crt"
        - name: TLS_PRIVATE_KEY_FILE
          value: "/var/run/example-service-apiserver/tls/tls.key"
        - name: KUBECONFIG
          value: ""
        - name: AUTHENTICATION_KUBECONFIG
          value: ""
        - name: AUTHENTICATION_SKIP_LOOKUP
          value: "false"
        - name: AUTHENTICATION_TOLERATE_LOOKUP_FAILURE
          value: "false"
        - name: AUTHORIZATION_KUBECONFIG
          value: ""
        - name: AUTHORIZATION_ALWAYS_ALLOW_PATHS
          value: "/healthz,/readyz,/livez"
        - name: REQUESTHEADER_CLIENT_CA_FILE
          value: ""
        - name: REQUESTHEADER_USERNAME_HEADERS
          value: "X-Remote-User"
        - name: REQUESTHEADER_GROUP_HEADERS
          value: "X-Remote-Group"
        - name: REQUESTHEADER_UID_HEADERS
          value: "X-Remote-Uid"
        - name: REQUESTHEADER_EXTRA_HEADERS_PREFIX
          value: "X-Remote-Extra-"
        - name: LOGGING_FORMAT
          value: "json"
        - name: LOG_LEVEL
          value: "4"
        - name: TRACING_CONFIG_FILE
          value: ""
        # TEMPLATE NOTE: Add your service-specific environment variables here
        # Example: database credentials, API keys, configuration values
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /healthz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 10
        volumeMounts:
        - name: tls-certs
          mountPath: /var/run/example-service-apiserver/tls
          readOnly: true
        - name: control-plane-ca
          mountPath: /etc/kubernetes/pki/requestheader
          readOnly: true
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tls-certs
        csi:
          driver: csi.cert-manager.io
          readOnly: true
          volumeAttributes:
            csi.cert-manager.io/issuer-name: selfsigned-cluster-issuer
            csi.cert-manager.io/issuer-kind: ClusterIssuer
            csi.cert-manager.io/common-name: example-service-apiserver.example-system.svc
            csi.cert-manager.io/dns-names: "example-service-apiserver,example-service-apiserver.example-system,example-service-apiserver.example-system.svc,example-service-apiserver.example-system.svc.cluster.local"
            csi.cert-manager.io/duration: "8760h"
            csi.cert-manager.io/renew-before: "720h"
            csi.cert-manager.io/fs-group: "65532"
      - name: control-plane-ca
        configMap:
          name: control-plane-ca
          optional: true
      - name: tmp
        emptyDir: {}
